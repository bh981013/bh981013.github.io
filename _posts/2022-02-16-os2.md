---
title: "3. virtual memory"
tags: 
    - CS
    - OS
    - project
    - operating system
categories: 
    - OS
comments: true
---

# 가상메모리의 등장 배경

프로그램을 실행시킬 때 컴퓨터가 필요한 부분은 __현재 실행시키고 있는__ 코드 부분이다. 즉, 어떤 프로그램을 실행할 때 해당 프로그램 코드의 모든 부분이 메모리에 올라와있을 필요는 없는 것이다.<br/><br/>

또한, 프로그램이 특정 메모리 공간에 접근하려고 할 때, 만약 다른 프로그램이 이미 사용하고 있는 부분에 접근하여 수정하게 된다면 문제가 생길 것이다. 즉, 프로그램마다 자기가 사용할 수 있는 주소값을 알고 있어야 한다는 것이다. 하지만 이것은 __보안상 문제__ 가 발생할 가능성이 있다.<br/><br/>

그래서 등장한 개념이 바로 __가상메모리(Virtual memory)__ 이다. 

# 가상메모리의 장점

## 메모리 공간 절약

메모리에는 현재 실행중인 프로그램만 올라와있을 수 있고, 그 중에도 현재 실행중인 코드가 존재하는 부분만 메모리에 존재하면 되므로, 메모리 공간을 절약할 수 있다.

## logical memory 공간과 physical memory공간이 다름

논리적인 주소값과 물리적인 주소값이 다르기 때문에, 각 프로세스마다 무한대의 주소공간을 할당받아 사용할 수 있다. 어차피 물리적인 변환과정에서 그 값을 바꾸면 되니까!

# 가상메모리의 구현

그럼 가상메모리를 어떻게 구현하면 될까?<br/><br/>

만약 원하는 데이터가 메모리에 존재한다면? 그 데이터를 바로 사용하면 된다. 하지만 만약 메모리에 존재하지 않으면, 디스크에서 원하는 데이터를 찾아서 메모리에 올려두면 된다.<br/><br/>

원하는 데이터가 메모리에 존재하는지에 대한 정보를 담고있는 테이블이 바로 __Page table__ 이다. 또한, 메모리와 디스크는 데이터를 페이지 단위로 관리하므로, 데이터가 아닌 페이지라고 지칭하겠다.<br/><br/>

그럼 page table은 특정 페이지가 메모리에 있는지를 어떻게 확인할까?

## valid-invalid bit

프로세스가 가상메모리 공간의 특정 페이지에 접근하려 할 때, page table을 확인하여 해당 페이지가 물리적 공간에 존재하는 지 확인한다. 테이블에서는 하나의 bit로 존재하는 지를 표현하는데, 그것이 바로 __valid-invalid bit__ 이다.

## page fault란

만약 프로세스가 요구하는 페이지가 물리적 메모리에 존재하지 않는다면, 디스크에서 해당 페이지를 가져와야 한다. 이러한 상황이 바로 page fault이다. page fault가 발생하면, OS는 허겁지겁 프로세스가 원하는 페이지를 찾아와야 한다! 분명 프로세스는 메모리에 값이 있다고 속이고 있는데, 막상 원하는 값이 없으면 난리가 나는 것이기 때문이다. 이때 OS에 인터럽트가 발생하는 데, 그것이 바로 __page fault trap__ 이다. 그리고 해당 trap을 해결하기 위해 trap handler가 실행된다.

## page fault 발생시 일어나는일.

그렇다면 trap handler가 일어난 과정을 알아보자.

1. 메모리의 빈 페이지 공간을 찾는다(만약 없으면, replace가 일어난다)

2. disk에서 프로세스가 요구하는 페이지를 찾아온다
    - 이때 I/O가 발생하므로, 어쩔 수 없이 wait queue로 들어간다. 
    - I/O가 끝나면 다시 ready queue로 이동한다.

3. 메모리의 빈 페이지 공간에 요구한 페이지를 집어넣고, 페이지 테이블을 수정한다.

4. 다시 프로세스의 instruction을 수행한다.




